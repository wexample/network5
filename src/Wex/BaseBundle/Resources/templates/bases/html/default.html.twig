{% import '@WexBaseBundle/Resources/templates/macros/assets.html.twig' as macro_assets %}

{%- set page_title_default = '@page::page_title' -%}
{%- set page_title = page_title|default(page_title_default) -%}
{%- set template_head_title_args = template_head_title_args|default({}) -%}
{%- set template_head_title = template_head_title|default(page_title) -%}
{%- set layout_name = layout_name|default(null) -%}
{%- set layout_no_js = layout_no_js|default(false) -%}
{%- set template_name = template_name_from_path(template_path) -%}

{%- block template_base -%}
    {%- block template_config -%}
        {{- assets_init_layout(layout_name) -}}
        {{- assets_init_template(template_name) -}}
    {%- endblock -%}

    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8"/>
        <title>{{ template_head_title ? (template_head_title | trans(template_head_title_args)) ~ ' | ' : '' }}{{ 'company.name' | trans }}</title>
        {% block preloads -%}
            {% for asset in assets_preload_list('css') %}
                <link rel="preload" href="{{ asset.path }}" as="{{ asset.preloadAs }}">
            {%- endfor %}
        {%- endblock %}

        {% block styles -%}
            {{ macro_assets.render_available_css(layout_no_js) }}
        {%- endblock %}
        {% if not layout_no_js %}
            <script>
                "use strict";

                // Use old school fashioned javascript notation to improve compatibility.
                var AppRegistryPart = function AppRegistryPart(context) {
                    this.context = context;
                    this.classes = {};
                };

                AppRegistryPart.prototype = {
                    add: function add(name, definition) {
                        // Prevent class override.
                        if (!this.classes[name]) {
                            this.classes[name] = definition;
                        }

                        var app = window.app;
                        var id = this.context + '.' + name;

                        if (!app.hasCoreLoaded) {
                            // Wait app launch to play with assets methods.
                            app.bootJsBuffer.push(id);
                        } else {
                            // Mark now that class is loaded.
                            app.assets.jsPendingLoaded(id);
                        }

                        // Return to allow export or extending class.
                        return definition;
                    }
                };

                window.appRegistry = {};

                [
                    'component',
                    'page',
                    'vue'
                ].forEach(function (item) {
                    window.appRegistry[item] = new AppRegistryPart(item);
                });

            </script>
            <style>
                .layout-loading {
                    display: none;
                }
            </style>
        {% endif %}
        {%- block meta -%}
            <meta name="viewport" content="width=device-width, user-scalable=no">
        {%- endblock -%}
    </head>
    <body>
    <div id="layout" class="layout-loading {{ layout_class|default('') }}">
        {#- If javascript fails to complete, force removing loading state after 2 seconds.      -#}
        <script>
            var elLayout = document.getElementById('layout');
            elLayout.classList.add('layout-loading');

            setTimeout(function () {
                elLayout.classList.remove('layout-loading');
            }, 2000);
        </script>
        {{ block('page_body') }}
    </div>

    {%- block template_assets -%}
        {{ macro_assets.render_available_css() }}

        {% if not layout_no_js %}
            <script type="text/javascript" src="{{ asset('build/runtime.js') }}"></script>
            {{ macro_assets.render_available_js() }}
            <script type="text/javascript">
                window.appRegistry.layoutData = {{ template_build_layout_data(template_name) | json_encode(constant('JSON_PRETTY_PRINT')) | raw }};
            </script>
        {%- endif -%}
    {%- endblock -%}
    </body>
    </html>
{%- endblock -%}
