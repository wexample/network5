{%- set page_title_default = '@page::page_title' -%}
{%- set page_title = page_title|default(page_title_default) -%}
{%- set template_head_title_args = template_head_title_args|default({}) -%}
{%- set template_head_title = template_head_title|default(page_title) -%}
{%- set layout_name = layout_name|default(null) -%}
{%- set layout_no_js = layout_no_js|default(false) -%}
{%- set template_name = template_name_from_path(template_path) -%}

{%- block template_base -%}
    {%- block template_config -%}
        {{- assets_init_layout(layout_name) -}}
        {{- assets_init_template(template_name) -}}
    {%- endblock -%}

    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8"/>
        <title>{{ template_head_title ? (template_head_title | trans(template_head_title_args)) ~ ' | ' : '' }}{{ 'company.name' | trans }}</title>
        {% block preloads -%}
            {% for asset in assets_preload_list('css') %}
                <link rel="preload" href="{{ asset.path }}" as="{{ asset.preloadAs }}">
            {%- endfor %}
        {%- endblock %}

        {% block styles -%}
            {% for asset in assets_list('css') %}
                {%- if not asset.responsive or layout_no_js -%}
                    <link id="{{ asset.name }}" rel="stylesheet" media="{{ asset.media }}"
                          href="{{ asset(asset.path) }}"/>
                {%- endif -%}

                {{- asset_set_loaded(asset) }}
            {% endfor %}
        {%- endblock %}
        {% if not layout_no_js %}
            <script>
                "use strict";

                // Use old school fashioned javascript notation to improve compatibility.
                var Registry = function Registry(group) {
                    this.group = group;
                    this.classes = {};
                };

                Registry.prototype = {
                    add: function add(name, definition) {
                        // Prevent class override.
                        if (!this.classes[name]) {
                            this.classes[name] = definition;
                        }

                        // Return to allow export or extending class.
                        return definition;
                    }
                };

                // We use different registry as they are used in several places to manage loading.
                window.appRegistry = {
                    components: new Registry('components'),
                    pages: new Registry('pages'),
                    vue: new Registry('vue'),
                    assets: {
                        responsive:{{ assets_render_responsive_list()|json_encode }}
                    }
                };
            </script>
            <style>
                .layout-loading {
                    display: none;
                }
            </style>
        {% endif %}
    </head>
    <body>
    <div id="layout" class="layout-loading {{ layout_class|default('') }}">
        {#- If javascript fails to complete, force removing loading state after 2 seconds.  -#}
        <script>
            var elLayout = document.getElementById('layout');
            elLayout.classList.add('layout-loading');

            setTimeout(function () {
                elLayout.classList.remove('loading');
            }, 2000);
        </script>
        {{ block('page_body') }}
    </div>

    {%- block template_assets -%}
        <script type="text/javascript" src="{{ asset('build/runtime.js') }}"></script>
        {%- for asset in assets_list('css') -%}
    <link rel="stylesheet" media="{{ asset.media }}" href="{{ asset(asset.path) }}"/>
        {{ asset_set_loaded(asset) }}
        {%- endfor -%}
        {%- for asset in assets_list('js') -%}
        <script type="text/javascript" src="{{ asset(asset.path) }}"></script>
        {{ asset_set_loaded(asset) }}
        {%- endfor -%}
        <script type="text/javascript">
            window.appRegistry.layoutData = {{ template_build_layout_data(template_name) | json_encode(constant('JSON_PRETTY_PRINT')) | raw }};
        </script>
    {%- endblock -%}
    </body>
    </html>
{%- endblock -%}
